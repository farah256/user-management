name: Build and SonarQube Analysis

on:
  push:
    branches: [ main ]

jobs:
  sonar:
    runs-on: macos-latest  # Changed to macOS runner

    steps:
      # 1️⃣ Checkout du code
      - uses: actions/checkout@v4
        with:
          submodules: false

      # 2️⃣ Setup JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: 21
          distribution: 'zulu'  # or 'temurin' for macOS

      # 3️⃣ Install Maven (if not already available)
      - name: Setup Maven
        uses: stCarolas/setup-maven@v4
        with:
          maven-version: '3.9.6'

      # 4️⃣ Build & SonarQube Analysis (using bash for macOS)
      - name: Build & SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL || 'http://localhost:9000' }}
        run: |
          # Debug: show URL and environment
          echo "Using SonarQube URL: $SONAR_HOST_URL"
          echo "Java version:"
          java -version
          echo "Maven version:"
          mvn --version
          
          # Run Maven with Sonar analysis
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=TP_SonarQube \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN
